<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journeyman Edge - Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="text-white">

    <div id="loader" class="flex justify-center items-center h-screen">
        <p class="text-lg font-semibold">Loading Checkout...</p>
    </div>

    <div id="content" class="hidden">
        <header class="bg-gray-900 border-b border-gray-800">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="index.html" class="flex items-center space-x-2">
                     <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 B24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <h1 class="text-xl font-black text-white">Journeyman<span class="text-blue-500">Edge</span></h1>
                </a>
                <a href="profile.html" class="text-gray-400 hover:text-white" title="Profile">
                    <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </a>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-8 max-w-lg">
            <div class="bg-gray-900 p-8 rounded-lg shadow-lg">
                <h2 class="text-3xl font-bold mb-6 text-center">Secure Checkout</h2>
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-400">Subscription:</span>
                        <span class="font-bold" id="summary-plan-name">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center text-lg">
                        <span class="text-gray-400">Trade:</span>
                        <span class="font-bold" id="summary-trade-name">Loading...</span>
                    </div>
                    <div class="border-t border-gray-700 my-4"></div>
                    <div class="flex justify-between items-center text-2xl">
                        <span class="font-bold">Total:</span>
                        <span class="font-bold text-blue-400" id="summary-total-price">--</span>
                    </div>
                </div>
                <button id="checkout-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-md text-lg transition duration-300 disabled:bg-gray-600">
                    Proceed to Payment
                </button>
                <p id="error-message" class="text-red-500 text-center mt-4 h-5"></p>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-functions.js"></script>
    <script src="firebase-init.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                document.getElementById('loader').textContent = 'Error: Firebase could not be initialized.';
                return;
            }

            const auth = firebase.auth();
            const functions = firebase.functions();
            
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            const summaryPlanName = document.getElementById('summary-plan-name');
            const summaryTradeName = document.getElementById('summary-trade-name');
            const summaryTotalPrice = document.getElementById('summary-total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const errorMessage = document.getElementById('error-message');

            let selectedPlan = null;
            let selectedTrade = null;
            
            // This is a test key. Replace with your actual publishable key in production.
            const stripe = Stripe('pk_test_51S2S4zDeWnk1QNpRuT5Kx50x4J4Q4Y9J3X7E8Z1E1Q8J4g5c6k7l8m9n0o1p2q3r4s5t6u7');

            auth.onAuthStateChanged(user => {
                if (user) {
                    loader.classList.add('hidden');
                    content.classList.remove('hidden');
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    selectedPlan = urlParams.get('plan');
                    selectedTrade = urlParams.get('trade');

                    const plans = {
                        '1m': { name: '1 Month Access', price: '$59 CAD' },
                        '6m': { name: '6 Months Access', price: '$99 CAD' },
                        '1y': { name: '1 Year Access', price: '$149 CAD' }
                    };

                    const tradeNames = {
                        electrician_construction: "Electrician", welder: "Welder", carpenter: "Carpenter", plumber: "Plumber", steamfitter_pipefitter: "Steamfitter", automotive_service_technician: "Automotive Tech", heavy_duty_equipment_technician: "Heavy Duty Tech", industrial_mechanic_millwright: "Millwright", cook: "Cook", hairstylist: "Hairstylist", sheet_metal_worker: "Sheet Metal", refrigeration_ac_mechanic: "Refrigeration", industrial_electrician: "Industrial Electrician", mobile_crane_operator: "Crane Operator", instrumentation_and_control_technician: "Instrumentation", painter_and_decorator: "Painter", ironworker: "Ironworker", boilermaker: "Boilermaker", bricklayer: "Bricklayer", powerline_technician: "Powerline Tech"
                    };

                    if (plans[selectedPlan] && tradeNames[selectedTrade]) {
                        summaryPlanName.textContent = plans[selectedPlan].name;
                        summaryTradeName.textContent = tradeNames[selectedTrade];
                        summaryTotalPrice.textContent = plans[selectedPlan].price;
                    } else {
                        window.location.href = 'index.html'; // Redirect if params are missing
                    }
                } else {
                    // Not signed in, redirect to login but save checkout intent
                    localStorage.setItem('checkoutRedirect', window.location.href);
                    window.location.href = 'login.html';
                }
            });

            checkoutBtn.addEventListener('click', async () => {
                checkoutBtn.disabled = true;
                checkoutBtn.textContent = 'Processing...';
                errorMessage.textContent = '';

                try {
                    const createStripeCheckout = functions.httpsCallable('createStripeCheckout');
                    const response = await createStripeCheckout({ plan: selectedPlan, trade: selectedTrade });
                    
                    const { id: sessionId } = response.data;
                    const { error } = await stripe.redirectToCheckout({ sessionId });

                    if (error) {
                       errorMessage.textContent = error.message;
                       checkoutBtn.disabled = false;
                       checkoutBtn.textContent = 'Proceed to Payment';
                    }
                } catch (error) {
                    console.error('Error calling cloud function:', error);
                    errorMessage.textContent = error.message || 'An unexpected error occurred.';
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'Proceed to Payment';
                }
            });
        });
    </script>
</body>
</html>