<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journeyman Edge - Your Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
        }
        .hidden {
            display: none;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            background-color: #1f2937;
        }
    </style>
</head>
<body class="text-white">

    <div id="loader" class="flex justify-center items-center h-screen">
        <p class="text-lg font-semibold">Loading Profile...</p>
    </div>

    <div id="content" class="hidden">
        <header class="bg-gray-900 border-b border-gray-800">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="index.html" class="flex items-center space-x-2">
                     <svg class="h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <h1 class="text-xl font-black text-white">Journeyman<span class="text-blue-500">Edge</span></h1>
                </a>
                <a href="profile.html" class="text-gray-400 hover:text-white" title="Profile">
                    <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </a>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            <h2 class="text-3xl font-bold mb-8">Your Profile</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <div class="md:col-span-1 bg-gray-900 p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col items-center">
                        <div class="w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-12 h-12 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold" id="user-name-display">Display Name</h3>
                        <p class="text-sm text-gray-400" id="user-email-display">user@email.com</p>
                        <p class="text-xs text-gray-500 mt-2" id="user-member-since">Member since...</p>
                        <button id="logout-btn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">Log Out</button>
                    </div>
                </div>

                <div class="md:col-span-2 bg-gray-900 p-6 rounded-lg shadow-lg">
                    <div>
                        <div class="border-b border-gray-700 mb-6">
                            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent" data-tab="subscriptions">My Subscriptions</button>
                                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-white hover:border-gray-500" data-tab="settings">Account Settings</button>
                            </nav>
                        </div>

                        <div id="subscriptions-panel" class="tab-panel">
                            <div id="no-subscriptions" class="hidden text-center py-12">
                                <p class="text-gray-400">You don't have any active subscriptions.</p>
                                <a href="index.html#pricing" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Browse Trades</a>
                            </div>
                            <div id="subscriptions-list" class="space-y-4">
                                </div>
                        </div>

                        <div id="settings-panel" class="tab-panel hidden">
                           <div class="space-y-8">
                                <div>
                                    <h4 class="text-lg font-bold mb-4">Change Display Name</h4>
                                    <form id="name-form" class="flex items-center space-x-4">
                                        <input type="text" id="display-name-input" placeholder="Enter new display name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500">
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md">Save</button>
                                    </form>
                                    <p id="name-message" class="text-sm mt-2 h-4"></p>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold mb-4">Change Password</h4>
                                    <form id="password-form" class="space-y-4">
                                        <input type="password" id="new-password" placeholder="New Password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500">
                                        <input type="password" id="confirm-new-password" placeholder="Confirm New Password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-white focus:ring-2 focus:ring-blue-500">
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md">Update Password</button>
                                    </form>
                                     <p id="password-message" class="text-sm mt-2 h-4"></p>
                                </div>
                           </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                document.getElementById('loader').textContent = 'Error: Firebase could not be initialized.';
                return;
            }

            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // --- General Page Elements ---
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            const logoutBtn = document.getElementById('logout-btn');

            // --- User Info Elements ---
            const userNameDisplay = document.getElementById('user-name-display');
            const userEmailDisplay = document.getElementById('user-email-display');
            const userMemberSince = document.getElementById('user-member-since');

            // --- Subscriptions Elements ---
            const noSubscriptionsMessage = document.getElementById('no-subscriptions');
            const subscriptionsList = document.getElementById('subscriptions-list');

            // --- Settings Form Elements ---
            const nameForm = document.getElementById('name-form');
            const displayNameInput = document.getElementById('display-name-input');
            const nameMessage = document.getElementById('name-message');
            const passwordForm = document.getElementById('password-form');
            const newPasswordInput = document.getElementById('new-password');
            const confirmNewPasswordInput = document.getElementById('confirm-new-password');
            const passwordMessage = document.getElementById('password-message');
            
            // --- Tab Elements ---
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            const tradeNames = {
                electrician_construction: "Electrician (Construction)", welder: "Welder", carpenter: "Carpenter", plumber: "Plumber", steamfitter_pipefitter: "Steamfitter / Pipefitter", automotive_service_technician: "Automotive Service Technician", heavy_duty_equipment_technician: "Heavy Duty Equipment Technician", industrial_mechanic_millwright: "Industrial Mechanic (Millwright)", cook: "Cook", hairstylist: "Hairstylist", sheet_metal_worker: "Sheet Metal Worker", refrigeration_ac_mechanic: "Refrigeration & AC Mechanic", industrial_electrician: "Industrial Electrician", mobile_crane_operator: "Mobile Crane Operator", instrumentation_and_control_technician: "Instrumentation & Control Technician", painter_and_decorator: "Painter and Decorator", ironworker: "Ironworker", boilermaker: "Boilermaker", bricklayer: "Bricklayer", powerline_technician: "Powerline Technician"
            };

            auth.onAuthStateChanged(user => {
                if (user) {
                    content.classList.remove('hidden');
                    loader.classList.add('hidden');

                    userEmailDisplay.textContent = user.email;
                    
                    const userDocRef = db.collection('users').doc(user.uid);
                    userDocRef.get().then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            userNameDisplay.textContent = userData.displayName || user.displayName || "New User";
                            if (userData.createdAt && userData.createdAt.toDate) {
                                const creationDate = userData.createdAt.toDate();
                                const formattedDate = creationDate.toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' });
                                userMemberSince.textContent = `Member since ${formattedDate}`;
                            }
                            displaySubscriptions(userData.subscriptions);
                        }
                    });
                } else {
                    window.location.href = 'login.html';
                }
            });

            function displaySubscriptions(subscriptions) {
                subscriptionsList.innerHTML = '';
                const activeSubs = subscriptions ? subscriptions.filter(s => s.status === 'active' && s.expirationDate.toDate() > new Date()) : [];

                if (activeSubs.length === 0) {
                    noSubscriptionsMessage.classList.remove('hidden');
                } else {
                    noSubscriptionsMessage.classList.add('hidden');
                    activeSubs.forEach(sub => {
                        const tradeName = tradeNames[sub.trade] || sub.trade;
                        const expiryDate = sub.expirationDate.toDate().toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' });
                        const subCard = `
                            <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-lg">${tradeName}</h4>
                                    <p class="text-sm text-gray-400">Expires: ${expiryDate}</p>
                                </div>
                                <a href="exam_app.html?trade=${sub.trade}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">
                                    Go to Exam
                                </a>
                            </div>
                        `;
                        subscriptionsList.innerHTML += subCard;
                    });
                }
            }
            
            // --- Event Listeners & Form Handlers from original file ---
             logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Logout Error:', error);
                });
            });

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active', 'border-blue-500', 'bg-gray-800'));
                    btn.classList.add('active', 'border-blue-500', 'bg-gray-800');
                    const tabName = btn.dataset.tab;
                    tabPanels.forEach(panel => {
                        panel.id === `${tabName}-panel` ? panel.classList.remove('hidden') : panel.classList.add('hidden');
                    });
                });
            });

            nameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = displayNameInput.value.trim();
                const user = auth.currentUser;
                if (!newName || !user) return;
                nameMessage.textContent = 'Saving...';
                user.updateProfile({ displayName: newName })
                    .then(() => db.collection('users').doc(user.uid).update({ displayName: newName }))
                    .then(() => {
                        userNameDisplay.textContent = newName;
                        nameMessage.textContent = 'Success!';
                        nameMessage.classList.add('text-green-500');
                    }).catch((error) => {
                        nameMessage.textContent = 'Error updating name.';
                        nameMessage.classList.add('text-red-500');
                    });
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmNewPasswordInput.value;
                passwordMessage.textContent = '';
                if (newPassword.length < 6) {
                    passwordMessage.textContent = "Password must be at least 6 characters.";
                    return;
                }
                if (newPassword !== confirmPassword) {
                    passwordMessage.textContent = "Passwords do not match.";
                    return;
                }
                auth.currentUser.updatePassword(newPassword).then(() => {
                    passwordMessage.textContent = 'Password updated successfully!';
                    passwordMessage.classList.add('text-green-500');
                    passwordForm.reset();
                }).catch((error) => {
                     passwordMessage.textContent = 'Error: ' + error.message;
                     passwordMessage.classList.add('text-red-500');
                });
            });
        });
    </script>
</body>
</html>